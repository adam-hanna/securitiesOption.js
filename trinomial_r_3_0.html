<!DOCTYPE html>
<html>
<head>
  <title>CRR Trinomail Model v3.0</title>
</head>
<body>
	<h1>Check the console!</h1>
</body>
</html>

<script>
	function securitiesOption(oConstructor) {
	    this.Spot = oConstructor.Spot;
	    this.Strike = oConstructor.Strike;
	    this.CorP = oConstructor.CorP.toLowerCase();
	    this.Sigma = oConstructor.Sigma;
	    this.Rf = oConstructor.Rf;
	    this.Days = oConstructor.Days
	    this.Nodes = Math.round((oConstructor.Nodes || 800), 0),

		this.CRR = function() {
			var Delta_t_yrs, Up, Down, Pu, Pd, Pm, Max_up, No_Underlying;

			Delta_t_yrs = (this.Days / 365 / this.Nodes);
			Up = (Math.exp((this.Sigma * Math.sqrt(2 * Delta_t_yrs))));
			Down = (1 / Up);
			Pu = (Math.pow((Math.exp(this.Rf * Delta_t_yrs / 2) - (Math.exp((-this.Sigma) * Math.sqrt(Delta_t_yrs / 2)))) / ((Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2))) - Math.exp((-this.Sigma) * Math.sqrt(Delta_t_yrs / 2))),2));
			Pd = (Math.pow(((Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2)) - Math.exp(this.Rf * Delta_t_yrs / 2)) / (Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2)) - Math.exp((-this.Sigma) * Math.sqrt(Delta_t_yrs / 2)))),2));
			Pm = (1 - Pu - Pd);
			Max_up = (this.Spot * Math.pow(Up, this.Nodes));
			No_Underlying = (this.Nodes * 2);

			console.log(Delta_t_yrs, Up, Down, Pu, Pd, Pm, Max_up, No_Underlying);

			var Underlying = [];
			var Derivative = [];

			//Input the final values of the underlying into the underlying array
			for (var i = 0; i <= No_Underlying; i++) {
				Underlying[i] = (Max_up * Math.pow(Down, i));
			};

			//populate the trinomial tree
			if (this.CorP === "call") {
			    //start with the leaves
			    Derivative[this.Nodes] = [];

			    for (var i = 0; i <= No_Underlying; i++) {
			    	Derivative[this.Nodes][i] = Math.max((Underlying[i] - this.Strike), 0);
			    };
			    
			    //now the branches
			    for (var k = 1; this.Nodes - k >= 0; k++) {
			    	Derivative[this.Nodes - k] = [];

			        for (var i = k; i <= No_Underlying - k; i++) {
			            Derivative[this.Nodes - k][i] = (Math.max((Underlying[i] - this.Strike), (Math.exp(((-this.Rf) * Delta_t_yrs))) * (Pu * Derivative[this.Nodes - k + 1][i - 1] + Pd * Derivative[this.Nodes - k + 1][i + 1] + Pm * Derivative[this.Nodes - k + 1][i])));
			        };
			    };
			} else if (this.CorP === "put") {
				 //start with the leaves
			    Derivative[this.Nodes] = [];

			    for (var i = 0; i <= No_Underlying; i++) {
			    	Derivative[this.Nodes][i] = Math.max((this.Strike - Underlying[i]), 0);
			    };
			    
			    //now the branches
			    for (var k = 1; this.Nodes - k >= 0; k++) {
			    	Derivative[this.Nodes - k] = [];

			        for (var i = k; i <= No_Underlying - k; i++) {
			            Derivative[this.Nodes - k][i] = (Math.max((this.Strike - Underlying[i]), (Math.exp(((-this.Rf) * Delta_t_yrs))) * (Pu * Derivative[this.Nodes - k + 1][i - 1] + Pd * Derivative[this.Nodes - k + 1][i + 1] + Pm * Derivative[this.Nodes - k + 1][i])));
			        };
			    };
			} else {
				return "Error!";
			};

			return Derivative[0][this.Nodes];

		}
	};


	var testOption = new securitiesOption({
	    Spot: 1418.16,
	    Strike: 3000,
	    CorP: "call",
	    Sigma: 0.3702,
	    Rf: 0.00261,
	    Days: 854,
	    Nodes: 800
	});

	console.log(testOption.CRR());

</script>