<!DOCTYPE html>
<html>
<head>
  <title>CRR Trinomail Model v3.0</title>
</head>
<body>
	<h1>Check the console!</h1>
</body>
</html>

<script>
	function securitiesOption(oConstructor) {
	    this.Spot = oConstructor.Spot.toExponential();
	    this.Strike = oConstructor.Strike.toExponential();
	    this.CorP = oConstructor.CorP.toLowerCase();
	    this.Sigma = oConstructor.Sigma.toExponential();
	    this.Rf = oConstructor.Rf.toExponential();
	    this.Days = oConstructor.Days.toExponential()
	    this.Nodes = Math.round((oConstructor.Nodes || 800), 0),

		this.CRR = function() {
			var Delta_t_yrs, Up, Down, Pu, Pd, Pm, Max_up, No_Underlying;

			Delta_t_yrs = (this.Days / 365 / this.Nodes).toExponential();
			Up = (Math.exp((this.Sigma * Math.sqrt(2 * Delta_t_yrs).toExponential()).toExponential()).toExponential());
			Down = (1 / Up).toExponential();
			Pu = (Math.pow((Math.exp(this.Rf * Delta_t_yrs / 2).toExponential() - (Math.exp((-this.Sigma).toExponential() * Math.sqrt(Delta_t_yrs / 2).toExponential())).toExponential()).toExponential() / ((Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2).toExponential())).toExponential() - Math.exp((-this.Sigma).toExponential() * Math.sqrt(Delta_t_yrs / 2).toExponential())),2)).toExponential();
			Pd = (Math.pow(((Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2).toExponential()) - Math.exp(this.Rf * Delta_t_yrs / 2).toExponential()) / (Math.exp(this.Sigma * Math.sqrt(Delta_t_yrs / 2).toExponential()) - Math.exp((-this.Sigma).toExponential() * Math.sqrt(Delta_t_yrs / 2).toExponential()))),2)).toExponential();
			Pm = (1 - Pu - Pd).toExponential();
			Max_up = (this.Spot * Math.pow(Up, this.Nodes).toExponential()).toExponential();
			No_Underlying = (this.Nodes * 2).toExponential();

			console.log(Delta_t_yrs, Up, Down, Pu, Pd, Pm, Max_up, No_Underlying);

			var Underlying = [];
			var Derivative = [];

			//Input the final values of the underlying into the underlying array
			for (var i = 0; i <= No_Underlying; i++) {
				Underlying[i] = (Max_up * Math.pow(Down, i).toExponential()).toExponential();
			};

			//populate the trinomial tree
			if (this.CorP === "call") {
			    //start with the leaves
			    Derivative[this.Nodes] = [];

			    for (var i = 0; i <= No_Underlying; i++) {
			    	Derivative[this.Nodes][i] = Math.max((Underlying[i] - this.Strike).toExponential(), 0).toExponential();
			    };
			    
			    //now the branches
			    for (var k = 1; this.Nodes - k >= 0; k++) {
			    	Derivative[this.Nodes - k] = [];

			        for (var i = k; i <= No_Underlying - k; i++) {
			        	//console.log(k);
			        	//console.log(i);
			            Derivative[this.Nodes - k][i] = (Math.max((Underlying[i] - this.Strike).toExponential(), (Math.exp(((-this.Rf).toExponential() * Delta_t_yrs))).toExponential() * (Pu * Derivative[this.Nodes - k + 1][i - 1] + Pd * Derivative[this.Nodes - k + 1][i + 1] + Pm * Derivative[this.Nodes - k + 1][i]).toExponential())).toExponential();
			            //console.log(Derivative[this.Nodes - k][i]);
			        };
			    };
			} else if (this.CorP === "put") {
				 //start with the leaves
			    Derivative[this.Nodes] = [];

			    for (var i = 0; i <= No_Underlying; i++) {
			    	Derivative[this.Nodes][i] = Math.max((this.Strike - Underlying[i]).toExponential(), 0).toExponential();
			    };
			    
			    //now the branches
			    for (var k = 1; this.Nodes - k >= 0; k++) {
			    	Derivative[this.Nodes - k] = [];

			        for (var i = k; i <= No_Underlying - k; i++) {
			        	//console.log(k);
			        	//console.log(i);
			            Derivative[this.Nodes - k][i] = (Math.max((this.Strike - Underlying[i]).toExponential(), (Math.exp(((-this.Rf).toExponential() * Delta_t_yrs))).toExponential() * (Pu * Derivative[this.Nodes - k + 1][i - 1] + Pd * Derivative[this.Nodes - k + 1][i + 1] + Pm * Derivative[this.Nodes - k + 1][i]).toExponential())).toExponential();
			            //console.log(Derivative[this.Nodes - k][i]);
			        };
			    };
			} else {
				return "Error!";
			}


			/*
			   'start with the leafs
			    For i = 0 To No_Underlying
			        Derivative(Nodes, i) = Max2(Strike - Underlying(i), 0)
			    Next i

			    'now the branches
			    k = 1
			    Do Until Nodes - k < 0
			        For i = k To No_Underlying - k
			            Derivative(Nodes - k, i) = Max2(Strike - Underlying(i), Exp(-Rf * Delta_t_yrs) * (Pu * Derivative(Nodes - k + 1, i - 1) + Pd * Derivative(Nodes - k + 1, i + 1) + Pm * Derivative(Nodes - k + 1, i)))
			        Next i
			    k = k + 1
			    
			    Loop

			Else

			Derivative(0, Nodes) = "Error"

			End If
			*/

			return Derivative[0][this.Nodes];

		}
	};


	var testOption = new securitiesOption({
	    Spot: 1418.16,
	    Strike: 3000,
	    CorP: "put",
	    Sigma: 0.3702,
	    Rf: 0.00261,
	    Days: 854,
	    Nodes: 80
	});

	console.log(testOption.CRR());

</script>